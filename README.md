# MILUINO
## Мои страдания с отечественными мк.
Я решил писать этот ридми в стиле своеобразного дневника. Мне кажется, при изучении чего-то, с чем не работал до этого, этот подход весьма уместен.
### Акт 1: Обновление прошивки программатора.
Платформой для отладки я избрал плату от АО "НПО КАДЕТЕК" - MILUINO на базе микроконтроллера Миландр MDR1211FI (aka К1986ВЕ92FI).
В качестве программатора-отладчика на ней стоит STlink V2 на базе чипа STM32F103CBT6. Прошивка в нем ожидаемо не актуальная и среды на неё ругаются. Обновить ее стандартными методами не удается (почему я так и не выяснил, возможно в схеме самой платы есть ошибка - утверждать не берусь).
Итак вот алгоритм обновления прошивки прогромматора до актуальной версии (на момент написания - 46) найденный мной:
1. Стереть утилитой STMFlashLoader  Demo через uart (есть на сайте ST). !ВАЖНО! - поставить перемычку в XP9 и uart подключать в XP5 (около USB) (второй uart разъем идет в миландр).
2. Зашить загрузчик той же утилитой (есть на сайте кадетека под этой [статьей](https://cadetech.ru/node/30) (есть еще на гитхабе [NR.electronics](https://github.com/nr-electronics/DiY/tree/master/ST-Link%20V2.1%20%2B%20VCP%20%2B%20Mass%20Storage/Stlink-Bootloaders-master)).
3. Скачать с сайта ST программу stsw-link007.
4. Перейти в директорию AllPlatforms.
5. Запустить STLinkUpgrade.jar из консоли с аргументами [отсюда]( https://github.com/blackmagic-debug/blackmagic/blob/main/src/platforms/stlink/README.md) (в конечном итоге я использовал этот вариант: ```java -jar STLinkUpgrade.jar -jtag -force_prog```, но работают все для стлинк 2 и 2.1 я проверял)
6. Программа прошьет стлинк и кинет ошибку.
  
   ![](img/error.jpg)
7. Переподключаем плату - готово прошивка обновлена.

   ![](img/cubeprog_fw_version.png)

### Акт 1.1: На плате есть проблемы. Много проблем.
Этот конкретный блок пишется значительно позже чем были написаны другие (Акт 1 и Акт 2). С момента их написания прошло уже порядка 4 месяцев (первые редакции readme.md датированы 04.05.2025 a на данный момент уже конец августа). За этот довольно продолжительный срок в плате выявлено немалое число проблем и нюансов которые необходимо учитывать в работе с ней. По части самого микроконтроллера тоже есть некоторые особенности.
1. Программатор (отладчик если угодно). На плате, как уже говорилось, стоит ST-Link, опустим проблемы с обновлением прошивки описанные выше и перейдем к сути. В моем случае он всю дорогу работал с перебоями а потом вовсе перестал работать с чипом окончательно и безповоротно (симптомы - определяется в системе но не может подключиться к таргету). Для встроенного ST-Link не помогло ничего из того до чего я сам дошел и того что мне советовали товарищи. Были испробовано:
   1. Переключение МК на работу с JTAG-A (по умолчанию используется JTAG-B).
   2. Стирание МК через UART при помощи утилиты 1986WSD
   3. Стирание МК при помощи внештатного программатора
   4. Смена на любую другую/ обновление/ откат до заводской версии прошивки программатора
  На данный момент программатор по прежнему остается в нерабочем состоянии, пришлось перейти на внешний отладчик. По началу был использован перепрошитый в J-LinkOB прогромматор ST-Link от WeAct Studio, затем был приобретен и до сих пор используется J-Link V9.
Я полагаю что если бы удалось перепрошить встроенный программатор в J-LinkOB то он исправно работал, однако проверить это невозможно т.к. опубликованная на сайте SEGGER утилита перепрошивки ST-Link в J-LinkOB не работает по причинам, вероятно аналогичным тем что описаны в Акте 1, а загрузить ПО от J-LinkOB в Stm32 способом которым загружается загрузчик не предствляется возможным ввиду отсутвия в свободном доступе файла прошивки.
  P.S. Я не знаю почему произошел "отвал" родного программатора никто из знакомых обладающих этими с подобным (конкретно с отвалом) не сталкивался. Возможно мне не повезло не знаю, здесь описан сугубо мой опыт.
2. Странные схемотехнические решения. А именно объединение немалого числа выводов МК вместе и банальное отсутвие некоторых, имеющихся в чипе, но не выведенных на гребенки платы сигналов, по непонятным мне причинам. Причины мне непонятны потому что на гребенках огромное число дублеров и NC пинов, грамотное использование которых с лихвой бы перекрыло все проблемы.
   

### Акт 2: Пробный проект (Blink).
Сборка проекта в IDE Keil не представляет никакой сложности для любого дошедшего до этого шага, и не представляет никакого интереса для меня ибо эта среда мне попросту неудобна. Посему было принято решение перебраться в родной vscode. Для чего у нас есть 2 путя:
1. Keil MDK-6. - 6 версия кейла поставляемая как расширение для vscode.
2. Самосбор на GCC.

Первый путь проще если времени в обрез и надо здесь и сейчас или попросту нет особого желания чуть-чуть поковырятся.
Вся простота первого пути лежит в возможности преобразовывать проекты Keil uvision из 5 в 6 версию с сохранеием обратной совместимости. Достаточно всего лишь скачать расширение ```Arm Keil Studio Pack (MDK v6)``` и выбрать кнопку ```Convert a uVision Project to CMSIS Solution```. Проект откроется среда скачает нужные пакеты, соглашаемся со всем, потом предложат скачать arm-debugger, также соглашаемся - профит. Отладка через встроенный stlink будет работать из коробки.

Путь два. Здесь я в основном опирался на [эту статью с хабра](https://habr.com/ru/articles/788776/?code=4c3cded164ba962ac25673c6004dc7c2&state=oBm2lZB4FiYvIRYNi3WK3ktQ&hl=ru). С той лишь разницей что мной была переделана структура проекта под мои предпочтения и произведен переход от отладки через jlink к отладке через встроенный stlink с помощью openocd. Проект-шаблон представлен в репозитории. Директория .vscode с файлами launch и tasks прикреплена также.
